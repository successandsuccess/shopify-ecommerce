{% comment %}
  Renders a product card

  Accepts:
  - card_product: {Object} Product Liquid object (optional)
  - media_aspect_ratio: {String} Size of the product image card. Values are "square" and "portrait". Default is "square" (optional)
  - image_shape: {String} Image mask to apply to the product image card. Values are "arch", "blob", "chevronleft", "chevronright", "diamond", "parallelogram", and "round". (optional)
  - show_secondary_image: {Boolean} Show the secondary image on hover. Default: false (optional)
  - show_vendor: {Boolean} Show the product vendor. Default: false
  - show_rating: {Boolean} Show the product rating. Default: false
  - extend_height: {Boolean} Card height extends to available container space. Default: true (optional)
  - lazy_load: {Boolean} Image should be lazy loaded. Default: true (optional)
  - show_quick_add: {Boolean} Show the quick add button.
  - section_id: {String} The ID of the section that contains this card.
  - horizontal_class: {Boolean} Add a card--horizontal class if set to true. Default: false (optional)
  - horizontal_quick_add: {Boolean} Changes the quick add button styles when set to true. Default: false (optional)
  - placeholder_image: {String} The placeholder image to use when no product exists. Default: 'product-apparel-2' (optional)

  Usage:
  {% render 'card-product', show_vendor: section.settings.show_vendor %}
{% endcomment %}

{{ 'component-rating.css' | asset_url | stylesheet_tag }}
{{ 'component-volume-pricing.css' | asset_url | stylesheet_tag }}

{% assign air_icon_tag = false %}

{%- if card_product and card_product != empty -%}
  {%- liquid
    assign ratio = 1
    if card_product.featured_media and media_aspect_ratio == 'portrait'
      assign ratio = 0.8
    elsif card_product.featured_media and media_aspect_ratio == 'adapt'
      assign ratio = card_product.featured_media.aspect_ratio
    elsif media_aspect_ratio == 'custom'
      assign ratio = 0.643
    endif
    if ratio == 0 or ratio == null
      assign ratio = 1
    endif
    
    for tag in card_product.tags
      if tag contains 'final sale' 
        assign final_sale_tag = true
      elsif tag contains 'justadded' 
        assign new_tag = true
      elsif tag contains 'tonaltee' 
        assign invisible_under_white_tag = true
      elsif tag contains 'restocked' 
        assign restocked_tag = true                                 
      endif
    endfor
  -%}
  
  {% capture card_classes %}
    card-wrapper product-card-wrapper underline-links-hover card-product-custom
    {% if mobile_drawer %}card-product-custom--mobile-drawer{% endif %}
    {% if enable_image_swiper_on_mobile == true %} card-product-mobile-swiper mobile-swiper-enabled{% endif %}
    {% if card_product.media.size > 1 %} has-media-list{% endif %}
    {% if section.settings.show_seo_content_product_content == true %} has_seo_content_product{% endif %}
    {% if enable_seo_content_product_clickable == true %} collection-card-products{% endif %}
  {% endcapture %}

  <div class="{{ card_classes }}">
    <div
      class="
        card card--{{ settings.card_style }}
        {% if card_product.featured_media %} card--media{% else %} card--text{% endif %}
        {% if settings.card_style == 'card' %} color-{{ settings.card_color_scheme }} gradient{% endif %}
        {% if image_shape and image_shape != 'default' %} card--shape{% endif %}
        {% if extend_height %} card--extend-height{% endif %}
        {% if card_product.featured_media == nil and settings.card_style == 'card' %} ratio{% endif %}
        {% if horizontal_class %} card--horizontal{% endif %}
      "
      style="--ratio-percent: {{ 1 | divided_by: ratio | times: 100 }}%;"
    >
      <div
        class="card__inner {% if settings.card_style == 'standard' %}color-{{ settings.card_color_scheme }} gradient{% endif %}{% if card_product.featured_media or settings.card_style == 'standard' %} ratio{% endif %}"
        style="--ratio-percent: {{ 1 | divided_by: ratio | times: 100 }}%;"
      >
        {% if card_product.tags contains 'air_icon' %}
          {% assign air_icon_tag = true %}
          <span class="label-tag air">
            <img src="{{ 'air_icon-min.png' | asset_url }}" width="80" height="80" loading="lazy" alt="Air Label Icon"> 
          </span> 
        {% endif %}
        {% if enable_seo_content_product_clickable == true %}
          <a href="{{ card_product.url | within: collection }}" class="full-unstyled-link image-link">
        {% endif %}
        {%- if card_product.featured_media -%}
          <div class="card__media{% if image_shape and image_shape != 'default' %} shape--{{ image_shape }} color-{{ settings.card_color_scheme }} gradient{% endif %}">
            <div class="media media--transparent media--hover-effect">
              
            {% if enable_image_swiper_on_mobile == true and card_product.media.size > 1 %}
                <div class="mobile-swiper large-up-hide">
                  <ul
                    class="grid grid-carousel js-mobile-swiper-wrapper"
                    data-product-handle="{{ card_product.handle }}"
                    data-product-url-with-collection="{{ card_product.url | within: collection }}">
                  </ul>
                </div> 
              {% endif %}
              {% capture first_image %}motion-reduce {% if forloop.first %} first-image{% endif %}{% endcapture %}
              {% capture loading_lazy %}{% unless lazy_load == false %}lazy{% endunless %}{% endcapture %}
              {% render 'card-product-image', image: card_product.featured_media, image_width: 533, image_class: first_image, image_loading: loading_lazy %}            
              {%- if card_product.media[2] != null and show_secondary_image -%}
                {% capture first_image %}motion-reduce {% if forloop.first %} first-image{% endif %}{% endcapture %}
                {% capture loading_lazy %}lazy{% endcapture %}
                {% render 'card-product-image', image: card_product.media[2], image_width: 533, image_class: first_image, image_loading: loading_lazy %}
              {% elsif card_product.media[2] == null and card_product.media[1] != null and show_secondary_image %}
                {% capture first_image %}motion-reduce {% if forloop.first %} first-image{% endif %}{% endcapture %}
                {% capture loading_lazy %}lazy{% endcapture %}
                {% render 'card-product-image', image: card_product.media[1], image_width: 533, image_class: first_image, image_loading: loading_lazy %}
              {%- endif -%}
            </div>
          </div>
        {%- endif -%}
        <div class="card__content">
          <div class="card__information">
            <span
              class="card__heading h3"
              {% if card_product.featured_media == null and settings.card_style == 'standard' %}
                id="title-{{ section_id }}-{{ card_product.id }}"
              {% endif %}
            >
              {% unless enable_seo_content_product_clickable == true %}
                <a
                  href="{{ card_product.url | within: collection }}"
                  id="StandardCardNoMediaLink-{{ section_id }}-{{ card_product.id }}"
                  class="full-unstyled-link"
                  aria-labelledby="StandardCardNoMediaLink-{{ section_id }}-{{ card_product.id }} NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}"
                >
              {% endunless %}
                {% if section.settings.show_seo_title == true  and card_product.metafields["global"]["seo_product_title"] != blank %}
                  {{ card_product.metafields["global"]["seo_product_title"] }}
                {% else %}
                  {{ card_product.title | escape }}
                {% endif %}
              {% unless enable_seo_content_product_clickable == true %}
                </a>
              {% endunless %}
            </span>
          </div>
          {% assign conditional_class = "" %}
          {% if settings.badge_position == "top right-conditional" and  air_icon_tag == true  %}
            {% assign conditional_class = "move-left" %}
          {% endif  %}
          <div class="card__badge {{ settings.badge_position }} {{ conditional_class }}">
            {%- if card_product.available == false -%}
              <span
                id="NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}"
                class="badge badge--bottom-left color-{{ settings.sold_out_badge_color_scheme }}"
              >
                {{- 'products.product.sold_out' | t -}}
              </span>
            {%- elsif final_sale_tag and card_product.available -%}
              <span
                id="NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}"
                class="badge sale badge--bottom-left color-{{ settings.sale_badge_color_scheme }}"
              >
                <span class="medium-hide small-hide">{{- 'products.product.badge_on_sale' | t -}}</span>
                <span class="large-up-hide">{{- 'products.product.on_sale' | t -}}</span>
              </span>
            {%- elsif new_tag -%}
              <span 
                id="NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}" 
                class="badge sale badge-new color-new">
                  {{- 'products.product.new_badge' | t -}}
              </span>
            {%- elsif invisible_under_white_tag -%}  
              <span 
                id="NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}" 
                class="badge sale color-{{ settings.sale_badge_color_scheme }}">
                  {{- 'products.product.invisible_under_white_badge' | t -}}
              </span>          
            {%- elsif restocked_tag -%} 
              <span 
                id="NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}" 
                class="badge color-{{ settings.sold_out_badge_color_scheme }}">
                  {{- 'products.product.restocked_badge' | t -}}
              </span>  
            {%- endif -%}
          </div>
        </div>
        {% if enable_seo_content_product_clickable == true %}
        </a>
        {% endif %}
      </div>
      <div class="card__content">
        <div class="card__information">
          {%- liquid
            assign total_colors = 0
            if card_product.available and card_product.variants.size > 1
              for option in card_product.options 
                if option == 'Color' 
                  for variant in card_product.variants 
                    assign total_colors = total_colors | plus: 1 
                  endfor 
                  break 
                endif 
              endfor 
            endif 
          -%}
          {%- if total_colors > 0  and enable_color_swatches == true -%}
            <div class="color-variants{% if total_colors == 0 %} hidden{% endif %}">
              {%- if card_product.variants.size > 1 %}
                {% comment %} <div
                  id="variant-radios-{{ section.id }}"                
                  class="no-js-hidden variant-radios"
                  data-section="{{ section.id }}"
                  data-url="{{ card_product.url }}" 
                  {% if update_url == false %}
                    data-update-url="false"
                  {% endif %}
                  {{ block.shopify_attributes }}
                >
                  {%- for option in card_product.options_with_values -%}
                    {% assign option_downcase = option.name | downcase %}
                    {% if option_downcase == 'color' %}
                      <fieldset class="js product-form__input variant-{{ option.name }}">
                        <legend class="form__label hidden">{{ option.name }}</legend>
                        <div class="variant-options">
                        {% render 'product-variant-options-btn', product: card_product, option: option, block: block %}
                        </div>
                      </fieldset>
                    {% endif %}
                  {% endfor %}
                </div>  {% endcomment %}
                <div
                  id="variant-radios-{{ section.id }}"
                  class="no-js-hidden variant-radios js-variant-radios"
                  data-section="{{ section.id }}"
                  data-url="{{ card_product.url }}" 
                  data-product-id="{{ card_product.id }}"
                  data-product-handle="{{ card_product.handle }}"
                  {% if update_url == false %}
                    data-update-url="false"
                  {% endif %}
                  {{ block.shopify_attributes }}
                >
                  <div class="animate-skeleton" style="display: flex; width: 100%; gap: 9px; margin: 1px 4px 14px;">
                    <div style="border-radius: 50%; width: 20px; aspect-ratio: 1; background-color: #fff; display:block;"></div>
                    <div style="border-radius: 50%; width: 20px; aspect-ratio: 1; background-color: #fff; display:block;"></div>
                    <div style="border-radius: 50%; width: 20px; aspect-ratio: 1; background-color: #fff; display:block;"></div>
                    <div style="border-radius: 50%; width: 20px; aspect-ratio: 1; background-color: #fff; display:block;"></div>
                  </div>
                </div>
              </div>
            {%- endif -%}
          {%- endif -%}

          
          <span
            class="card__heading{% if card_product.featured_media or settings.card_style == 'standard' %} h5{% endif %}"
            {% if card_product.featured_media or settings.card_style == 'card' %}
              id="title-{{ section_id }}-{{ card_product.id }}"
            {% endif %}
          >
            {% if enable_seo_content_product_clickable == true %}
              <span class="full-unstyled-link">
                {% if section.settings.show_seo_title == true and card_product.metafields["global"]["seo_product_title"] != blank %}
                  {{ card_product.metafields["global"]["seo_product_title"] }}
                {% else %}
                  {{ card_product.title | escape }}
                {% endif %}
              </span>
            {% else %}
              <a
                href="{{ card_product.url | within: collection }}"
                id="CardLink-{{ section_id }}-{{ card_product.id }}"
                class="full-unstyled-link"
                aria-labelledby="CardLink-{{ section_id }}-{{ card_product.id }} Badge-{{ section_id }}-{{ card_product.id }}"
              >
                {% if section.settings.show_seo_title == true and card_product.metafields["global"]["seo_product_title"] != blank %}
                  {{ card_product.metafields["global"]["seo_product_title"] }}
                {% else %}
                  {{ card_product.title | escape }}
                {% endif %}
              </a>
            {% endif %}
          </span>
          <div class="card-information">
            {%- if show_vendor -%}
              <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
              <div class="caption-with-letter-spacing light">{{ card_product.vendor }}</div>
            {%- endif -%}

            <span class="caption-large light">{{ block.settings.description | escape }}</span>

            {%- if show_rating and card_product.metafields.reviews.rating.value != blank -%}
              {% liquid
                assign rating_decimal = 0
                assign decimal = card_product.metafields.reviews.rating.value.rating | modulo: 1
                if decimal >= 0.3 and decimal <= 0.7
                  assign rating_decimal = 0.5
                elsif decimal > 0.7
                  assign rating_decimal = 1
                endif
              %}
              <div
                class="rating"
                role="img"
                aria-label="{{ 'accessibility.star_reviews_info' | t: rating_value: card_product.metafields.reviews.rating.value, rating_max: card_product.metafields.reviews.rating.value.scale_max }}"
              >
                <span
                  aria-hidden="true"
                  class="rating-star"
                  style="--rating: {{ card_product.metafields.reviews.rating.value.rating | floor }}; --rating-max: {{ card_product.metafields.reviews.rating.value.scale_max }}; --rating-decimal: {{ rating_decimal }};"
                ></span>
              </div>
              <p class="rating-text caption">
                <span aria-hidden="true">
                  {{- card_product.metafields.reviews.rating.value }} /
                  {{ card_product.metafields.reviews.rating.value.scale_max -}}
                </span>
              </p>
              <p class="rating-count caption">
                <span aria-hidden="true">({{ card_product.metafields.reviews.rating_count }})</span>
                <span class="visually-hidden">
                  {{- card_product.metafields.reviews.rating_count }}
                  {{ 'accessibility.total_reviews' | t -}}
                </span>
              </p>
            {%- endif -%}

            {% liquid
                assign single_item_price_text = blank
                assign calculated_price = card_product.price
                assign enable_tooltip = true
                for discount in shop.metaobjects.discount.values
                  assign original_price = card_product.price
                  assign bundle_enabled = false
                  assign tier1_discount_percentage = 0
                  assign tier2_discount_percentage = 0
                  assign tier3_discount_percentage = 0
                  assign bundles_starts_from = 0
                  assign discounted_price_x2 = 0
                  assign discounted_price_x3 = 0
                  assign discounted_price_x4 = 0
                  assign largest_discount_bundle = 0
                  assign highest_discount_percentage = 0
                  assign text = discount.text.value
                  assign tier1_text = discount.tier_1_message
                  assign tier2_text = discount.tier_2_message
                  assign tier3_text = discount.tier_3_message
                
                  for collection_item in discount.specific_collections.value
                    if collection_item == collection or card_product.collections contains collection_item

                      if discount.single_item_price != blank and discount.single_item_price_text != blank
                         assign calculated_price = discount.single_item_price.value
                         assign original_price = discount.single_item_price.value
                         if localization.country.iso_code == 'US'
                           assign single_item_price = discount.single_item_price.value | money_without_trailing_zeros | remove: ' '
                           assign single_item_slash_price = discount.single_item_slash_price.value | money_without_trailing_zeros | remove: ' '
                         else
                           assign single_item_price = discount.single_item_price.value | money_without_trailing_zeros
                           assign single_item_slash_price = discount.single_item_slash_price.value | money_without_trailing_zeros
                         endif
                         assign single_item_price_text = discount.single_item_price_text | replace: "[price]", single_item_price | replace: "[slash_price]", single_item_slash_price
                      endif
                     
                      if discount.tier1_buy2.value != blank
                        assign tier1_val_discount = discount.tier1_buy2.value
                        assign bundles_starts_from = 2
                        if original_price > 0
                          assign discount_times_hundred = tier1_val_discount | times: 100
                          assign tier1_discount_percentage = discount_times_hundred | divided_by: original_price | floor
                        endif
                        assign largest_discount_bundle = 2
                        assign highest_discount_percentage = tier1_discount_percentage
                        assign original_price_x2 = calculated_price | times: 2
                        assign tier1_discount_x2 = tier1_val_discount | times: 2
                        assign discounted_price_x2 = original_price_x2 | minus: tier1_discount_x2
                      endif
  
  
                      if discount.tier2_buy3.value != blank
                        assign tier2_val_discount = discount.tier2_buy3.value
                        if bundle_starts_from == 0
                          assign bundles_starts_from = 3
                        endif
                        if original_price > 0
                          assign discount_times_hundred = tier2_val_discount | times: 100
                          assign tier2_discount_percentage = discount_times_hundred | divided_by: original_price | floor
                          if tier2_discount_percentage > highest_discount_percentage
                            assign largest_discount_bundle = 3
                            assign highest_discount_percentage = tier2_discount_percentage
                          endif
                          assign original_price_x3 = calculated_price | times: 3
                          assign tier2_discount_x3 = tier2_val_discount | times: 3
                          assign discounted_price_x3 = original_price_x3 | minus: tier2_discount_x3
                        endif
                      endif
  
                      if discount.tier3_buy4.value != blank
                        assign tier3_val_discount = discount.tier3_buy4.value
                        if bundle_starts_from == 0
                          assign bundles_starts_from = 4
                        endif
                        if original_price > 0
                          assign discount_times_hundred = tier3_val_discount | times: 100
                          assign tier3_discount_percentage = discount_times_hundred | divided_by: original_price | floor
                          if tier3_discount_percentage > highest_discount_percentage
                            assign largest_discount_bundle = 3
                            assign highest_discount_percentage = tier3_discount_percentage
                          endif
                          assign original_price_x4 = calculated_price | times: 4
                          assign tier3_discount_x4 = tier3_val_discount | times: 4
                          assign discounted_price_x4 = original_price_x4 | minus: tier3_discount_x4
                        endif
                      endif
                
                      break
                    endif
                  endfor
  
                  if tier1_val_discount or tier2_val_discount or tier3_val_discount

                    if tier1_val_discount
                      if localization.country.iso_code == 'US' 
                        assign tier1_price_with_currency = discounted_price_x2 | money_without_trailing_zeros | remove: ' '
                        assign tier1_price_per_with_currency = calculated_price | minus: tier1_val_discount | money_without_trailing_zeros | remove: ' ' 
                      else
                        assign tier1_price_with_currency = discounted_price_x2 | money_without_trailing_zeros 
                        assign tier1_price_per_with_currency = calculated_price | minus: tier1_val_discount | money_without_trailing_zeros 
                      endif
                      assign tier1_message = tier1_text | replace: "[quantity]", "2" | replace: "[price]", tier1_price_with_currency | replace: "[price_per]", tier1_price_per_with_currency | replace: "[percentage]", tier1_discount_percentage
                    endif
                      
                    if tier2_val_discount
                      if localization.country.iso_code == 'US' 
                        assign tier2_price_with_currency = discounted_price_x3 | money_without_trailing_zeros | remove: ' '
                        assign tier2_price_per_with_currency = calculated_price | minus: tier2_val_discount | money_without_trailing_zeros | remove: ' ' 
                      else
                        assign tier2_price_with_currency = discounted_price_x3 | money_without_trailing_zeros 
                        assign tier2_price_per_with_currency = calculated_price | minus: tier2_val_discount | money_without_trailing_zeros 
                      endif
                      assign tier2_message = tier2_text | replace: "[quantity]", "3" | replace: "[price]", tier2_price_with_currency | replace: "[price_per]", tier2_price_per_with_currency | replace: "[percentage]", tier2_discount_percentage
                    endif
                      
                    if tier3_val_discount
                      if localization.country.iso_code == 'US' 
                        assign tier3_price_with_currency = discounted_price_x4 | money_without_trailing_zeros | remove: ' '
                        assign tier3_price_per_with_currency = calculated_price | minus: tier3_val_discount | money_without_trailing_zeros | remove: ' ' 
                      else
                        assign tier3_price_with_currency = discounted_price_x4 | money_without_trailing_zeros 
                        assign tier3_price_per_with_currency = calculated_price | minus: tier3_val_discount | money_without_trailing_zeros  
                      endif
                      assign tier3_message = tier3_text | replace: "[quantity]", "4" | replace: "[price]", tier3_price_with_currency | replace: "[price_per]", tier3_price_per_with_currency | replace: "[percentage]", tier3_discount_percentage
                    endif
                
                    assign discount_summary_option = discount.discount_summary.value
      
                    case discount_summary_option
                      when 'Min Products for Max Possible Discount'
                        assign discount_summary = 'Buy ' | append: bundles_starts_from | append: '+ & save ' | append: highest_discount_percentage | append: '%'
                      when 'Best Deal (Max Bundle & Highest Discount)'
                        assign discount_summary = 'Buy' | append: largest_discount_bundle | append: ' & Save ' | append: highest_discount_percentage | append: '%'
                      when 'Tier 1 Bundle no. of items and Discount'
                        assign discount_summary = text | replace: "[quantity]", "2" | replace: "[price]", tier1_price_with_currency | replace: "[price_per]", tier1_price_per_with_currency | replace: "[percentage]", tier1_discount_percentage
                      when 'Tier 2 Bundle no. of items and Discount'
                        assign discount_summary = text | replace: "[quantity]", "3" | replace: "[price]", tier2_price_with_currency | replace: "[price_per]", tier2_price_per_with_currency | replace: "[percentage]", tier2_discount_percentage
                      when 'Tier 3 Bundle no. of items and Discount'
                        assign discount_summary = text | replace: "[quantity]", "4" | replace: "[price]", tier3_price_with_currency | replace: "[price_per]", tier3_price_per_with_currency | replace: "[percentage]", tier3_discount_percentage
                      when 'Custom Message'
                        assign discount_summary = text | replace: "[tier1_price]", tier1_price_with_currency | replace: "[tier1_price_per]", tier1_price_per_with_currency | replace: "[tier1_percentage]", tier1_discount_percentage
                        assign discount_summary = discount_summary | replace: "[tier2_price]", tier2_price_with_currency | replace: "[tier2_price_per]", tier2_price_per_with_currency | replace: "[tier2_percentage]", tier2_discount_percentage
                        assign discount_summary = discount_summary | replace: "[tier3_price]", tier3_price_with_currency | replace: "[tier3_price_per]", tier3_price_per_with_currency | replace: "[tier3_percentage]", tier3_discount_percentage
                        assign enable_tooltip = false
                      else 
                    endcase
                    assign bundle_enabled = true
                  break
                endif 
              endfor
                
            %}

            {% liquid
              if final_sale_tag
                assign bundle_enabled = false
              endif
            %}

             <div style="position: relative; z-index: 1;">
              <spark-product-card parent-id="{{ card_product.id }}"></spark-product-card>
            </div>
            {% render 'price', product: card_product, price_class: '', show_compare_at_price: true, single_item_price_text: single_item_price_text %}
            {%- if card_product.quantity_price_breaks_configured? -%}
              <div class="card__information-volume-pricing-note">
                <span class="caption">{{ 'products.product.volume_pricing.note' | t }}</span>
              </div>
            {%- endif -%}
  
            {% if bundle_enabled %}
              {% comment %}TODO: Replace hardcoded strings with localized variables{% endcomment %}
              <div class="bundle-save">
                <p class="bundle-text">{{ discount_summary }}
                  {% if enable_tooltip %}
                    <span class="bundle-tooltip-icon">
                      {% render 'icon-bundle-tool' %}
                    </span>
                  {% endif %}
                </p> 
                {% if enable_tooltip %}
                  <div class="bundle-tooltip">
                  <span class="large-up-hide tooltip-close">
                    {% render 'modal-close' %}
                  </span>
                  {% if tier1_val_discount or tier2_val_discount or tier3_val_discount %}
                    <span class="tooltip-heading h4">Buy More & Save</span>
                    <ul>
                      {% if tier1_val_discount %}
                        <li>
                          {% render 'icon-star' %}
                          {{ tier1_message }}
                        </li>
                      {% endif %}
                      {% if tier2_val_discount %}
                        <li>
                          {% render 'icon-star' %}
                          {{ tier2_message }}
                        </li>
                      {% endif %}
                      {% if tier3_val_discount %}
                        <li>
                          {% render 'icon-star' %}
                          {{ tier3_message }}
                        </li>
                      {% endif %}
                    </ul>
                    {% endif %}
                  </div>
                {% endif %}
            </div>
          {% endif %}

          </div>
          {% if final_sale_tag %}
            <div class="final-sale">
              <p>
                <span class="final-sale-label">{{ 'products.product.final_sale' | t }}</span>
                <a class="final-sale-link" href="{{ section.settings.final_sale_link }}" target="_blank">{{ 'products.product.terms_conditions' | t }}</a>
              </p>
            </div>
          {% endif %}
        </div>
        {%- if show_quick_add -%}
          <div data-spark="b2c-only" class="quick-add no-js-hidden">
            {%- liquid
              assign product_form_id = 'quick-add-' | append: section_id | append: card_product.id
              assign qty_rules = false
              if card_product.selected_or_first_available_variant.quantity_rule.min > 1 or card_product.selected_or_first_available_variant.quantity_rule.max != null or card_product.selected_or_first_available_variant.quantity_rule.increment > 1
                assign qty_rules = true
              endif
            -%}
            {%- if card_product.variants.size > 1 or qty_rules -%}
              <modal-opener data-modal="#QuickAdd-{{ card_product.id }}">
                <button
                  id="{{ product_form_id }}-submit"
                  type="submit"
                  name="add"
                  class="quick-add__submit button button--full-width button--primary{% if horizontal_quick_add %} card--horizontal__quick-add animate-arrow{% endif %}"
                  aria-haspopup="dialog"
                  aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                  data-product-url="{{ card_product.url }}"
                >
                  {% render 'icon-quickview' %}
                  {% render 'icon-quickview-mobile' %}
                  {{ 'products.product.quickview_label' | t }}
                  {%- if horizontal_quick_add -%}
                    <span class="icon-wrap">{% render 'icon-arrow' %}</span>
                  {%- endif -%}
                  <div class="loading-overlay__spinner hidden">
                    <svg
                      aria-hidden="true"
                      focusable="false"
                      class="spinner"
                      viewBox="0 0 66 66"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </div>
                </button>
              </modal-opener>
              <quick-add-modal id="QuickAdd-{{ card_product.id }}" class="quick-add-modal">
                <div
                  role="dialog"
                  aria-label="{{ 'products.product.choose_product_options' | t: product_name: card_product.title | escape }}"
                  aria-modal="true"
                  class="quick-add-modal__content global-settings-popup"
                  tabindex="-1"
                >
                  <button
                    id="ModalClose-{{ card_product.id }}"
                    type="button"
                    class="quick-add-modal__toggle"
                    aria-label="{{ 'accessibility.close' | t }}"
                  >
                    {% render 'icon-close' %}
                  </button>
                  <div id="QuickAddInfo-{{ card_product.id }}" class="quick-add-modal__content-info"></div>
                </div>
              </quick-add-modal>
            {%- else -%}
              <product-form data-spark="b2c-only" data-section-id="{{ section.id }}">
                {%- form 'product',
                  card_product,
                  id: product_form_id,
                  class: 'form',
                  novalidate: 'novalidate',
                  data-type: 'add-to-cart-form'
                -%}
                  <input
                    type="hidden"
                    name="id"
                    value="{{ card_product.selected_or_first_available_variant.id }}"
                    class="product-variant-id"
                    {% if card_product.selected_or_first_available_variant.available == false %}
                      disabled
                    {% endif %}
                  >
                  <button
                    id="{{ product_form_id }}-submit"
                    type="submit"
                    name="add"
                    class="quick-add__submit button button--full-width button--secondary{% if horizontal_quick_add %} card--horizontal__quick-add{% endif %}"
                    aria-haspopup="dialog"
                    aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                    aria-live="polite"
                    data-sold-out-message="true"
                    {% if card_product.selected_or_first_available_variant.available == false %}
                      disabled
                    {% endif %}
                  >
                    {% render 'icon-quickview' %}
                    {% render 'icon-quickview-mobile' %}
                    <span>
                      {%- if card_product.selected_or_first_available_variant.available -%}
                        {{ 'products.product.add_to_cart' | t }}
                      {%- else -%}
                        {{ 'products.product.sold_out' | t }}
                      {%- endif -%}
                    </span>
                    <span class="sold-out-message hidden">
                      {{ 'products.product.sold_out' | t }}
                    </span>
                    {%- if horizontal_quick_add -%}
                      <span class="icon-wrap">{% render 'icon-plus' %}</span>
                    {%- endif -%}
                    <div class="loading-overlay__spinner hidden">
                      <svg
                        aria-hidden="true"
                        focusable="false"
                        class="spinner"
                        viewBox="0 0 66 66"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                      </svg>
                    </div>
                  </button>
                {%- endform -%}
              </product-form>
            {%- endif -%}
          </div>
        {%- endif -%}
        <div class="card__badge {{ settings.badge_position }}">
          {%- if card_product.available == false -%}
            <span
              id="Badge-{{ section_id }}-{{ card_product.id }}"
              class="badge badge--bottom-left color-{{ settings.sold_out_badge_color_scheme }}"
            >
              {{- 'products.product.sold_out' | t -}}
            </span>
          {%- elsif final_sale_tag and card_product.available -%}
            <span
              id="Badge-{{ section_id }}-{{ card_product.id }}"
              class="badge badge--bottom-left color-{{ settings.sale_badge_color_scheme }}"
            >
              {{- 'products.product.on_sale' | t -}}
            </span>
            {%- elsif new_tag -%}
            <span 
              id="NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}" 
              class="badge sale badge-new color-{{ settings. sale_badge_color_scheme }}">
                {{- 'products.product.new_badge' | t -}}
            </span>
          {%- elsif invisible_under_white_tag -%}
            <span
              id="NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}" 
              class="badge sale color-{{ settings. sale_badge_color_scheme }}">
                {{- 'products.product.invisible_under_white_badge' | t -}}
            </span>
          {%- elsif restocked_tag -%} 
            <span
              id="NoMediaStandardBadge-{{ section_id }}-{{ card_product.id }}" 
              class="badge color-{{ settings.  sold_out_badge_color_scheme }}">
                {{- 'products.product.restocked_badge' | t -}}
            </span>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>
{%- else -%}
  <div class="card-wrapper product-card-wrapper underline-links-hover">
    <div
      class="
        card card--{{ settings.card_style }}
        {% if extend_height %} card--extend-height{% endif %}
        {% if settings.card_style == 'card' %} color-{{ settings.card_color_scheme }} gradient{% endif %}
      "
      style="--ratio-percent: 100%;"
    >
      <div
        class="card__inner{% if settings.card_style == 'standard' %} color-{{ settings.card_color_scheme }} gradient{% endif %} ratio"
        style="--ratio-percent: 100%;"
      >
        <div class="card__media">
          <div class="media media--transparent">
            {%- if placeholder_image -%}
              {{ placeholder_image | placeholder_svg_tag: 'placeholder-svg' }}
            {%- else -%}
              {{ 'product-apparel-2' | placeholder_svg_tag: 'placeholder-svg' }}
            {% endif %}
          </div>
        </div>
      </div>
      <div class="card__content">
        <div class="card__information">
          <span class="card__heading card__heading--placeholder{% if settings.card_style == 'standard' %} h5{% endif %}">
            <a role="link" aria-disabled="true" class="full-unstyled-link">
              {{ 'onboarding.product_title' | t }}
            </a>
          </span>
          <div class="card-information">
            {%- if show_vendor -%}
              <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
              <div class="caption-with-letter-spacing light">{{ 'products.product.vendor' | t }}</div>
            {%- endif -%}
            {% render 'price', show_compare_at_price: true %}
            {% if card_product.compare_at_price > card_product.price and card_product.available %}
              <div class="final-sale">
                <p>
                  <span class="final-sale-label">{{ 'products.product.final_sale' | t }}</span>
                  <a class="final-sale-link" href="{{ section.settings.final_sale_link }}" target="_blank">{{ 'products.product.terms_conditions' | t }}</a>
                </p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
{%- endif -%}
{% if enable_seo_content_product_clickable == true %}
    {%- liquid
      assign seo_content_product_array = card_product.metafields["global"]["seo_content_product"] | split: '<h2>'
      assign seo_content_product = seo_content_product_array[0] | split: '<h1>' 
    -%}
    <a href="{{ card_product.url | within: collection }}" class="card_seo_content h4 full-unstyled-link">
      {{ seo_content_product }}
    </a>
  {% else %}
  {% if section.settings.show_seo_content_product_content == true  and card_product.metafields["global"]["seo_content_product"] != blank %}
    {%- liquid
      assign seo_content_product_array = card_product.metafields["global"]["seo_content_product"] | split: '<h2>'
      assign seo_content_product = seo_content_product_array[0] | split: '<h1>' 
    -%}
  <span class="card_seo_content h4">{{ seo_content_product }}</span>
  {% endif %}
{% endif %} 

